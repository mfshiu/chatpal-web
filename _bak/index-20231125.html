<!DOCTYPE html>

<html
  lang="en"
  class="light-style layout-navbar-fixed layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="../static/assets/"
  data-template="vertical-menu-template"
>
  <head>
    {% include 'layout/head.html' %}

    <style>
    </style>
  </head>

  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        {% include 'layout/menu.html' %}

        <!-- Layout container -->
        <div class="layout-page">

          {% include 'layout/navbar.html' %}

          <div class="content-wrapper">
            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
              <button id="startButton" class="btn btn-primary">Start</button>
            </div>
            <!-- / Content -->

            {% include 'layout/footer.html' %}

            <div class="content-backdrop fade"></div>
          </div>
        </div>
        <!-- / Layout page -->
      </div>

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>

      <!-- Drag Target Area To SlideIn Menu On Small Screens -->
      <div class="drag-target"></div>
    </div>
    <!-- / Layout wrapper -->

    {% include 'layout/bodytail.html' %}

    <script>
      $(document).ready(function () {
        
      });
    </script>

    <script>
      var _isSpeaking = false;

      document.getElementById('startButton').addEventListener('click', async function() {
        console.log('Start recording.');

        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        await audioContext.audioWorklet.addModule("{{ url_for('static', filename='js/audioProcessor.js') }}");
    
        let microphoneStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        let microphone = audioContext.createMediaStreamSource(microphoneStream);
        let audioProcessorNode = new AudioWorkletNode(audioContext, 'audio-processor');
    
        audioProcessorNode.port.onmessage = (event) => {
          if (event.data.speaking) {
            _isSpeaking = true;
            console.log('@@@@@@@@@@@@@@@');
          } else {
            _isSpeaking = false;
            console.log('...............');
          }
        };
    
        microphone.connect(audioProcessorNode).connect(audioContext.destination);
      });
      
      // Placeholder function for VAD - you would replace this with a real implementation
      function isUserSpeaking() {
          return _isSpeaking; // This should be the result of the VAD check
      }

      let recording = false;
      let silenceTimer;
      const maxDuration = 10000; // 10 seconds
      let mediaRecorder;
      let audioChunks = [];

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

          setInterval(() => {
              if (isUserSpeaking()) {
                  if (!recording) {
                      audioChunks = [];
                      mediaRecorder.start();
                      recording = true;

                      setTimeout(() => {
                          if (recording) {
                              mediaRecorder.stop();
                              recording = false;
                          }
                      }, maxDuration);
                  }

                  clearTimeout(silenceTimer);
                  silenceTimer = setTimeout(() => {
                      if (recording) {
                          mediaRecorder.stop();
                          recording = false;
                      }
                  }, 1000); // Stop if silence for more than 1 second
              }
          }, 100); // Check every 100ms

          mediaRecorder.onstop = () => {
            var audioBlob = new Blob(audioChunks);
            var formData = new FormData();
            formData.append("audio_data", audioBlob);
            fetch("/upload_voice", { method: "POST", body: formData });
          };
        });
    </script>
  </body>
</html>
