<!DOCTYPE html>

<html
  lang="en"
  class="light-style layout-navbar-fixed layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="../static/assets/"
  data-template="vertical-menu-template"
>
  <head>
    {% include 'layout/head.html' %}

    <style>
    </style>
  </head>

  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        {% include 'layout/menu.html' %}

        <!-- Layout container -->
        <div class="layout-page">

          {% include 'layout/navbar.html' %}

          <div class="content-wrapper">
            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
              <button id="startButton" class="btn btn-primary">Start</button>
              <button id="stopButton" class="btn btn-danger">Stop</button>
            </div>
            <!-- / Content -->

            {% include 'layout/footer.html' %}

            <div class="content-backdrop fade"></div>
          </div>
        </div>
        <!-- / Layout page -->
      </div>

      <!-- Overlay -->
      <div class="layout-overlay layout-menu-toggle"></div>

      <!-- Drag Target Area To SlideIn Menu On Small Screens -->
      <div class="drag-target"></div>
    </div>
    <!-- / Layout wrapper -->

    {% include 'layout/bodytail.html' %}

    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web@0.0.7/dist/bundle.min.js"></script>

    <script>
      $(document).ready(function () {
        
      });
    </script>

    <script>
      let is_pause = true;
      let mediaRecorder;
      let audioChunks = [];

      document.getElementById('startButton').addEventListener('click', async function() {
        console.log('Start recording.');
        is_pause = false;
      });

      document.getElementById('stopButton').addEventListener('click', async function() {
        console.log('Stop recording.');
        is_pause = true;
        audioChunks = [];
      });

      async function main() {
        const myvad = await vad.MicVAD.new({
          onSpeechStart: () => {
            if (is_pause) {
              return;
            }
            console.log("Speech start detected")
            navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
              mediaRecorder = new MediaRecorder(stream);
              mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
              mediaRecorder.start();
              console.log("Start recording.");
            });
          },
          onSpeechEnd: (audio) => {
            // do something with `audio` (Float32Array of audio samples at sample rate 16000)...
            if (is_pause) {
              return;
            }
            console.log("Speech end")
            mediaRecorder.stop();
            mediaRecorder.onstop = () => {
              console.log("Upload wave. audioChunks:", audioChunks.length);
              const audioBlob = new Blob(audioChunks, { 'type' : 'audio/wav; codecs=opus' });
              audioChunks = [];

              var formData = new FormData();
              formData.append("audio_data", audioBlob);
              fetch("/upload_voice", { method: "POST", body: formData });
            }
          }
        })
        myvad.start()
      }
      main()

    </script>
  </body>
</html>
